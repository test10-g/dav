name: rclone WebDAV

on:
  schedule:
    - cron: "0 */6 * * *"        # เปิดเองทุก 6 ชั่วโมง
  workflow_dispatch:             # กดเองได้ด้วย

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Install rclone
        run: curl https://rclone.org/install.sh | sudo bash

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Serve WebDAV
        run: |
          nohup rclone serve webdav gdrive:/ --addr :8080 --user ${{ secrets.WEBDAV_USER }} --pass ${{ secrets.WEBDAV_PASS }} &

      - name: Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Run Cloudflare Tunnel
        run: cloudflared tunnel run --token ${{ secrets.CF_TOKEN }}
