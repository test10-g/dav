name: rclone WebDAV via Cloudflare

on:
  schedule:
    - cron: "0 */6 * * *"  # รันทุก 6 ชั่วโมง
  workflow_dispatch:        # รันด้วยตนเองได้

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Serve WebDAV + Cloudflare Tunnel
        run: |
          # รัน Rclone WebDAV แบบ background
          nohup rclone serve webdav gdrive-mx:/ \
            --addr :8080 \
            --user ${{ secrets.WEBDAV_USER }} \
            --pass ${{ secrets.WEBDAV_PASS }} > rclone.log 2>&1 &
          
          # รอให้ Rclone เริ่มทำงาน
          sleep 5

          # รัน Cloudflare Tunnel ไปที่ Rclone
          nohup cloudflared tunnel run --token ${{ secrets.CF_TOKEN }} \
            --url http://localhost:8080 > cloudflared.log 2>&1 &

          echo "Rclone WebDAV is running on localhost:8080 via Cloudflare Tunnel"

          
          # รัน 6 ชั่วโมง (21600 วินาที) แล้วจบ
          sleep 21600