name: Rclone WebDAV via Cloudflare (1h)

on:
  workflow_dispatch:

jobs:
  serve:
    runs-on: ubuntu-latest

    steps:
      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      - name: Setup rclone config
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG }}" > ~/.config/rclone/rclone.conf

      - name: Install cloudflared
        run: |
          wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared-linux-amd64.deb

      - name: Serve WebDAV + Cloudflare Tunnel
        run: |
          # รัน Rclone WebDAV แบบ background
          nohup rclone serve webdav gdrive-mx:/ \
            --addr :8080 \
            --user ${{ secrets.WEBDAV_USER }} \
            --pass ${{ secrets.WEBDAV_PASS }} > rclone.log 2>&1 &

          # รอให้ Rclone เริ่มทำงาน
          sleep 5

         # รัน Cloudflare Tunnel แบบ background
          nohup cloudflared tunnel run --token ${{ secrets.CF_TOKEN }} > cloudflared.log 2>&1 &

        # รอให้ tunnel เชื่อมต่อ (20 วินาที)
          sleep 20

        # ดึง public URL จาก tunnel info
          PUBLIC_URL=$(cloudflared tunnel info e75d4d6e-c05b-47d1-8963-08950280cba2 | grep -oP 'https://[a-z0-9.-]+\.trycloudflare\.com' | head -n1)

          echo "==============================="
          echo "WebDAV via Cloudflare Tunnel URL: $PUBLIC_URL"
          echo "Username: ${{ secrets.WEBDAV_USER }}"
          echo "Password: ${{ secrets.WEBDAV_PASS }}"
          echo "==============================="

